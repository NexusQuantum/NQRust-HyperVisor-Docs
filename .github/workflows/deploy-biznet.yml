name: Deploy to Biznet Cloud

on:
  push:
    branches:
      - main
      - 'feat/**'
  workflow_dispatch:

jobs:
  build:
    name: Build Docusaurus Site
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 1. Optimize Disk Space
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost

      # 2. Configure Swap (Resize Strategy)
      # We disable the existing swap first to avoid "Text file busy" errors
      - name: Configure Swap Space (4GB)
        run: |
          echo "Disabling current swap..."
          sudo swapoff -a
          
          echo "Removing old swap file..."
          sudo rm -f /swapfile

          echo "Allocating new 4GB swap file..."
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          
          echo "Memory Status:"
          free -h

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        run: |
          npm install -g yarn
          yarn install --frozen-lockfile

      - name: Generate API Documentation
        env:
          NODE_OPTIONS: "--max_old_space_size=4096"
        run: yarn gen-api-docs || true

      - name: Build Static Site
        env:
          NODE_OPTIONS: "--max_old_space_size=4096"
        run: yarn build

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: build/
          retention-days: 1
          if-no-files-found: error

  deploy:
    name: Deploy to Production
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
          path: build/

      - name: Deploy to Biznet VPS (SCP)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.BIZNET_HOST }}
          username: ${{ secrets.BIZNET_USERNAME }}
          key: ${{ secrets.BIZNET_SSH_KEY }}
          port: ${{ secrets.BIZNET_SSH_PORT }}
          source: "build/*"
          target: ${{ secrets.BIZNET_DEPLOY_PATH }}
          strip_components: 1
          rm: true
          timeout: 600s

      - name: Reload Caddy Server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.BIZNET_HOST }}
          username: ${{ secrets.BIZNET_USERNAME }}
          key: ${{ secrets.BIZNET_SSH_KEY }}
          port: ${{ secrets.BIZNET_SSH_PORT }}
          script: |
            echo "ðŸ”„ Reloading Caddy service..."
            sudo systemctl reload caddy